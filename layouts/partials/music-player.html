{{/* Logic to build the playlist from posts with audio frontmatter */}}
{{ $playlist := slice }}

{{ range where .Site.RegularPages "Params.audio" "!=" nil }}
{{ $audioPath := .Params.audio }}
{{/* Extract song title from audio path (remove /audio/ prefix and .mp3/.wav suffix) */}}
{{ $songTitle := $audioPath | replaceRE "^/?(audio/)?" "" | replaceRE "\\.(mp3|wav)$" "" }}
{{ $playlist = $playlist | append (dict "title" $songTitle "audio" $audioPath "link" .RelPermalink) }}
{{ end }}

{{/* Render the Player Div - Always Visible */}}
<div id="music-player" class="music-player-bar glass-bar" data-playlist='{{ $playlist | jsonify }}' {{ if .Params.audio
    }}data-initial-audio="{{ .Params.audio }}" {{ end }}>

    <!-- Album Art / Icon -->
    <div class="player-icon">
        <div class="playing-indicator">
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
        </div>
    </div>

    <!-- Info Section (Left) -->
    <div class="bar-info">
        <span id="current-song-title" class="bar-song-title">Select a song...</span>
        <a id="song-post-link" href="#" class="bar-post-link" title="Read associated post">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
            </svg>
            이 글 읽기
        </a>
    </div>

    <!-- Controls Section (Center/Right) -->
    <div class="bar-controls">
        <!-- Play/Pause -->
        <button id="music-control" class="bar-control-btn play-btn" aria-label="Play/Pause">
            <svg id="icon-play" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
            <svg id="icon-pause" class="hidden" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"
                stroke="none">
                <rect x="6" y="4" width="4" height="16"></rect>
                <rect x="14" y="4" width="4" height="16"></rect>
            </svg>
        </button>

        <!-- Seek Bar -->
        <div class="bar-seek-container">
            <input type="range" id="seek-slider" class="bar-slider" min="0" max="100" value="0" step="0.1"
                aria-label="Seek">
        </div>

        <!-- Volume (Desktop only often) -->
        <div class="bar-volume-container mobile-hidden">
            <input type="range" id="volume-slider" class="bar-slider volume-slider" min="0" max="1" step="0.01"
                value="0.2" aria-label="Volume">
        </div>

        <!-- Playlist Toggle - Always available -->
        <button id="playlist-toggle" class="bar-control-btn list-btn" aria-label="Playlist">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="8" y1="6" x2="21" y2="6"></line>
                <line x1="8" y1="12" x2="21" y2="12"></line>
                <line x1="8" y1="18" x2="21" y2="18"></line>
                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                <line x1="3" y1="18" x2="3.01" y2="18"></line>
            </svg>
        </button>
    </div>

    <!-- Playlist Popup -->
    <div id="playlist-container" class="bar-playlist-popup hidden">
        <div class="playlist-header">
            <span>Playlist</span>
            <button id="close-playlist-btn" class="close-btn-mini">×</button>
        </div>
        <ul id="playlist-list">
            <!-- Items injected by JS -->
        </ul>
    </div>

    <audio id="bgm-audio" preload="auto" loop>
        <source src="" type="audio/mpeg">
    </audio>
</div>

{{/* Load Music Player CSS & JS */}}
{{ $music_css := resources.Get "css/music-player.css" | minify | fingerprint }}
<link rel="stylesheet" href="{{ $music_css.Permalink }}" integrity="{{ $music_css.Data.Integrity }}">

{{ $music_js := resources.Get "js/music-player.js" | fingerprint }}
<script src="{{ $music_js.Permalink }}" integrity="{{ $music_js.Data.Integrity }}"></script>