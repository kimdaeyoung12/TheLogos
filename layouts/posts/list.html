{{ define "main" }}
<!-- 3D Background Container -->
<div id="three-canvas-container"></div>

<!-- Inline CSS for 3D Container -->
<style>
    #three-canvas-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        z-index: -1;
        /* LIGHT MODE: 'Morning Romance' - Soft Pastel Sunrise */
        background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
        overflow: hidden;
    }

    body.dark #three-canvas-container {
        /* DARK MODE: 'Midnight Romance' - Deep Velvet Purple/Navy */
        background: radial-gradient(circle at 50% 50%, #232526 0%, #0f0c29 100%);
    }

    .timeline-item {
        background: rgba(30, 41, 59, 0.85);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border-radius: 16px;
    }

    .timeline-item:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
    }

    .page-title {
        color: #f8fafc !important;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .page-description {
        color: #94a3b8 !important;
    }

    .filter-btn {
        background: rgba(30, 41, 59, 0.8) !important;
        border-color: rgba(255, 255, 255, 0.1) !important;
        color: #e2e8f0 !important;
    }

    .filter-btn.active {
        background: rgba(99, 102, 241, 0.8) !important;
    }

    /* Responsive Search Bar */
    .search-container {
        width: 100%;
        max-width: 600px;
        /* PC Limit */
        margin: 0 auto 20px auto;
    }

    .search-input {
        width: 100%;
        box-sizing: border-box;
        /* Prevent padding overflow */
    }

    /* LIGHT MODE SPECIFIC STYLES */
    body:not(.dark) .timeline-item {
        background: rgba(255, 255, 255, 0.75);
        /* White Glass */
        border: 1px solid rgba(0, 0, 0, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    body:not(.dark) .timeline-title a {
        color: #1e293b !important;
        /* Dark Text */
    }

    body:not(.dark) .timeline-excerpt {
        color: #475569 !important;
        /* Dark Grey Text */
    }

    body:not(.dark) .page-title {
        color: #1e293b !important;
        text-shadow: none;
    }

    body:not(.dark) .page-description {
        color: #475569 !important;
    }
</style>

<!-- Three.js Inline Module - OPTIMIZED FOR SPEED -->
<script type="module">
    import * as THREE from 'https://cdn.skypack.dev/three@0.132.2';

    // --- Zombie Killer ---
    if (window.posts3DReqId) {
        cancelAnimationFrame(window.posts3DReqId);
    }
    if (window.posts3DCleanup) {
        window.posts3DCleanup();
    }

    const container = document.getElementById('three-canvas-container');

    if (container) {
        // Scene
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 500);
        camera.position.set(0, 0, 70);

        // Renderer - Performance Optimized
        const renderer = new THREE.WebGLRenderer({
            alpha: true,
            antialias: false,  // Disable for performance
            powerPreference: "high-performance"
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5)); // Lower DPR limit
        container.appendChild(renderer.domElement);

        // Cinematic/Romance Lighting & Atmosphere
        scene.add(new THREE.AmbientLight(0xffffff, 0.6)); // Soft general light
        const mainLight = new THREE.DirectionalLight(0xffd1b3, 1.5); // Warm sunset key light
        mainLight.position.set(20, 20, 50);
        scene.add(mainLight);

        // Soft Fog for Depth (Cinematic Feel)
        scene.fog = new THREE.FogExp2(0x111116, 0.008);

        // Planet Group
        const group = new THREE.Group();
        scene.add(group);
        const planets = {};

        // Cinematic Materials (Matte, Satin, Soft Glow - Not Metallic)
        const matteGold = new THREE.MeshStandardMaterial({
            color: 0xffac41, roughnes: 0.7, metalness: 0.1, emissive: 0x553311, emissiveIntensity: 0.2
        });
        const matteBlue = new THREE.MeshStandardMaterial({
            color: 0x3e5eb3, roughness: 0.8, metalness: 0.0, emissive: 0x112244, emissiveIntensity: 0.3
        });
        const matteSilver = new THREE.MeshStandardMaterial({
            color: 0xcbd5e1, roughness: 0.5, metalness: 0.3
        });
        const softPearl = new THREE.MeshStandardMaterial({
            color: 0xfff1f2, roughness: 0.9, emissive: 0x332222, emissiveIntensity: 0.1
        });

        // Initial Positions (Desktop Defaults)
        // Religion (Top Extreme Right) - Trinity/Fire -> Tetrahedron (matches single.html)
        const religionPlanet = new THREE.Mesh(new THREE.TetrahedronGeometry(7, 0), matteGold);
        group.add(religionPlanet);
        planets['religion'] = { mesh: religionPlanet, camPos: { x: 40, y: 15, z: -10 } };

        // Philosophy (Top Extreme Left) - Universe/Aether -> Dodecahedron (matches single.html)
        const philoPlanet = new THREE.Mesh(new THREE.DodecahedronGeometry(6, 0), matteBlue);
        group.add(philoPlanet);
        planets['philosophy'] = { mesh: philoPlanet, camPos: { x: -40, y: 10, z: -15 } };

        // Engineering (Mid Extreme Left) - Structure/Diamond -> Octahedron (matches single.html)
        const engPlanet = new THREE.Mesh(new THREE.OctahedronGeometry(8, 0), matteSilver);
        // Engineering wireframe overlay (matches single.html)
        const wireGeo = new THREE.OctahedronGeometry(8.2, 0);
        const wireMat = new THREE.MeshBasicMaterial({ color: 0xffffff, wireframe: true, transparent: true, opacity: 0.3 });
        engPlanet.add(new THREE.Mesh(wireGeo, wireMat));
        group.add(engPlanet);
        planets['engineering'] = { mesh: engPlanet, camPos: { x: -45, y: -5, z: -20 } };

        // Writing (Mid Extreme Right) - Flow/Pearl -> Sphere (same in both)
        const writePlanet = new THREE.Mesh(new THREE.SphereGeometry(5, 32, 32), softPearl);
        group.add(writePlanet);
        planets['writing'] = { mesh: writePlanet, camPos: { x: 45, y: -5, z: -10 } };

        // Responsive Layout Logic
        function updatePlanetLayout() {
            const isMobile = window.innerWidth < 768;

            if (isMobile) {
                // Mobile: Closer, Smaller, Vertically Stacked
                // Scale Down
                Object.values(planets).forEach(p => p.mesh.scale.set(0.6, 0.6, 0.6));

                // Reposition for Portrait FOV
                planets['religion'].mesh.position.set(18, 25, -50);
                planets['philosophy'].mesh.position.set(-18, 15, -50);
                planets['engineering'].mesh.position.set(-15, -30, -60);
                planets['writing'].mesh.position.set(15, -30, -60);
            } else {
                // Desktop: Wide & Cinematic
                Object.values(planets).forEach(p => p.mesh.scale.set(1, 1, 1));

                planets['religion'].mesh.position.set(60, 25, -40);
                planets['philosophy'].mesh.position.set(-60, 20, -40);
                planets['engineering'].mesh.position.set(-70, -5, -50);
                planets['writing'].mesh.position.set(70, -5, -30);
            }
        }
        updatePlanetLayout(); // Initial Call

        // Soft Star Field (Fewer, smaller, subtle)
        const starGeo = new THREE.BufferGeometry();
        const starPos = new Float32Array(1500 * 3); /* Increased count for cosmic feel */
        for (let i = 0; i < 1500; i++) {
            starPos[i * 3] = (Math.random() - 0.5) * 400;
            starPos[i * 3 + 1] = (Math.random() - 0.5) * 400;
            starPos[i * 3 + 2] = (Math.random() - 0.5) * 200 - 80;
        }
        starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
        const starMat = new THREE.PointsMaterial({ size: 0.4, color: 0xffffff, transparent: true, opacity: 0.8 });
        const stars = new THREE.Points(starGeo, starMat);
        scene.add(stars);

        // Theme Awareness for Stars (Dark Stars in Light Mode)
        function updateStarColor() {
            const isDark = document.body.classList.contains('dark');
            if (isDark) {
                stars.material.color.setHex(0xffffff); // White stars in dark space
                stars.material.opacity = 0.6;
            } else {
                stars.material.color.setHex(0x445566); // Dark Navy stars in light sky
                stars.material.opacity = 0.5;
            }
        }

        // Initial Check
        updateStarColor();

        // Observe Theme Class Changes
        const observer = new MutationObserver(updateStarColor);
        observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });

        // Camera Targets
        let targetCameraPos = new THREE.Vector3(0, 0, 70);
        let targetLookAt = new THREE.Vector3(0, 0, 0);

        // Event Listener
        if (window.postsNavListener) {
            window.removeEventListener('category-changed', window.postsNavListener);
        }
        window.postsNavListener = (e) => {
            const cat = e.detail.category;
            if (cat === 'all' || !planets[cat]) {
                targetCameraPos.set(0, 0, 70);
                targetLookAt.set(0, 0, 0);
            } else {
                const p = planets[cat];
                targetCameraPos.set(p.camPos.x, p.camPos.y, p.camPos.z);
                targetLookAt.copy(p.mesh.position);
            }
        };
        window.addEventListener('category-changed', window.postsNavListener);

        // Animation Loop - FAST lerp (0.15 per frame = instant feel)
        function animate() {
            // Simple rotation
            religionPlanet.rotation.y += 0.005;
            philoPlanet.rotation.y -= 0.004;
            engPlanet.rotation.x += 0.003;
            writePlanet.rotation.y += 0.004;

            // SMOOTH Camera Movement (0.05 = elegant)
            camera.position.lerp(targetCameraPos, 0.05);
            camera.lookAt(targetLookAt);

            // Slow star rotation
            stars.rotation.z += 0.0002;

            renderer.render(scene, camera);
            window.posts3DReqId = requestAnimationFrame(animate);
        }
        animate();

        // Debounced Resize
        let resizeTimer;
        const onResize = () => {
            clearTimeout(resizeTimer);
            updatePlanetLayout(); // Update positions on resize
            resizeTimer = setTimeout(() => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }, 100);
        };
        window.addEventListener('resize', onResize);

        // Cleanup Function
        window.posts3DCleanup = () => {
            window.removeEventListener('resize', onResize);
            if (window.postsNavListener) {
                window.removeEventListener('category-changed', window.postsNavListener);
            }
            renderer.dispose();
            renderer.forceContextLoss();
        };
    }
</script>

<section class="posts-list-section">
    <div class="container">
        <header class="page-header">
            <h1 class="page-title">Posts</h1>
            <p class="page-description">Ï¢ÖÍµê, Ï≤†Ìïô, Í≥µÌïô, Í∏ÄÏì∞Í∏∞Ïóê ÎåÄÌïú ÏÉùÍ∞ÅÍ≥º ÌÜµÏ∞∞ÏùÑ ÎÇòÎàïÎãàÎã§</p>

            <!-- Search Box -->
            <div class="search-container">
                <input type="text" id="search-input" class="search-input" placeholder="üîç Í≤åÏãúÎ¨º Í≤ÄÏÉâ..." autocomplete="off">
                <button class="search-clear" id="search-clear" style="display:none;" aria-label="Í≤ÄÏÉâÏñ¥ ÏßÄÏö∞Í∏∞">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                        stroke-linecap="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <!-- Unified Filter Buttons -->
            <div class="category-filters">
                <button class="filter-btn active" data-category="all">
                    <span class="icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                        </svg>
                    </span>
                    <span>Ï†ÑÏ≤¥</span>
                </button>
                <button class="filter-btn" data-category="religion">
                    <span class="icon">{{ (index .Site.Data.categories "religion").icon | safeHTML }}</span>
                    <span>Ï¢ÖÍµê</span>
                </button>
                <button class="filter-btn" data-category="philosophy">
                    <span class="icon">{{ (index .Site.Data.categories "philosophy").icon | safeHTML }}</span>
                    <span>Ï≤†Ìïô</span>
                </button>
                <button class="filter-btn" data-category="engineering">
                    <span class="icon">{{ (index .Site.Data.categories "engineering").icon | safeHTML }}</span>
                    <span>Í≥µÌïô</span>
                </button>
                <button class="filter-btn" data-category="writing">
                    <span class="icon">{{ (index .Site.Data.categories "writing").icon | safeHTML }}</span>
                    <span>Í∏ÄÏì∞Í∏∞</span>
                </button>
            </div>
        </header>

        <!-- Timeline Layout -->
        <div class="timeline">
            {{ $posts := where .Site.RegularPages "Section" "posts" }}
            {{ $posts = $posts.ByDate.Reverse }}
            {{ $grouped := $posts.GroupByDate "2006" }}

            {{ range $grouped }}
            <div class="timeline-year">
                <h2 class="year-label">{{ .Key }}</h2>

                <div class="timeline-items">
                    {{ range .Pages }}
                    {{ $category := "uncategorized" }}
                    {{ if .Params.categories }}
                    {{ $category = index .Params.categories 0 | lower }}
                    {{ end }}

                    {{ $catData := index $.Site.Data.categories $category }}
                    {{ $catColor := "#666" }}
                    {{ $catIcon := "" }}
                    {{ $catName := $category }}
                    {{ if $catData }}
                    {{ $catColor = $catData.color }}
                    {{ $catIcon = $catData.icon }}
                    {{ $catName = $catData.name }}
                    {{ end }}
                    {{ $tags := slice }}
                    {{ range .Params.tags }}
                    {{ $tags = $tags | append (. | urlize) }}
                    {{ end }}

                    <article class="timeline-item" data-category="{{ $category }}" data-tags="{{ delimit $tags " ," }}">
                        <div class="timeline-marker" style="background: {{ $catColor }};"></div>
                        <div class="timeline-content">
                            <div class="timeline-meta">
                                <span class="timeline-date">{{ .Date.Format "Jan 2" }}</span>
                                <span class="timeline-category"
                                    style="color: {{ $catColor }}; display: flex; align-items: center; gap: 4px;">
                                    {{ $catIcon | safeHTML }} {{ $catName }}
                                </span>
                            </div>
                            <h3 class="timeline-title">
                                <a href="{{ .RelPermalink }}">{{ .Title }}</a>
                            </h3>
                            <p class="timeline-excerpt">
                                {{ .Summary | plainify | htmlUnescape | truncate 120 }}
                            </p>
                        </div>
                    </article>
                    {{ end }}
                </div>
            </div>
            {{ end }}
        </div>

        {{ if not $posts }}
        <p class="no-posts" style="text-align: center; margin-top: 40px; color: var(--text-secondary);">ÏïÑÏßÅ ÏûëÏÑ±Îêú Í∏ÄÏù¥ ÏóÜÏäµÎãàÎã§.
        </p>
        {{ end }}
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const filterBtns = document.querySelectorAll('.filter-btn');
        const searchInput = document.getElementById('search-input');
        const searchClear = document.getElementById('search-clear');
        const items = Array.from(document.querySelectorAll('.timeline-item'));
        const yearSections = document.querySelectorAll('.timeline-year');

        const itemsData = items.map(item => ({
            element: item,
            category: item.getAttribute('data-category'),
            tags: (item.getAttribute('data-tags') || '').split(',').filter(t => t),
            text: (
                (item.querySelector('.timeline-title')?.textContent || '') + ' ' +
                (item.querySelector('.timeline-excerpt')?.textContent || '')
            ).toLowerCase().normalize('NFC')
        }));

        let currentFilter = 'all';
        let currentQuery = '';
        let currentTag = '';

        function runFilter() {
            itemsData.forEach(data => {
                const matchesCategory = currentFilter === 'all' || data.category === currentFilter;
                const matchesSearch = !currentQuery || data.text.includes(currentQuery);
                const matchesTag = !currentTag || data.tags.includes(currentTag);
                const shouldShow = matchesCategory && matchesSearch && matchesTag;

                if (shouldShow) {
                    data.element.style.display = 'flex';
                    data.element.style.opacity = '1';
                } else {
                    data.element.style.display = 'none';
                }
            });

            yearSections.forEach(section => {
                const hasVisible = Array.from(section.querySelectorAll('.timeline-item'))
                    .some(el => el.style.display !== 'none');
                section.style.display = hasVisible ? 'block' : 'none';
            });
        }

        function setCategory(category, updateUrl = false) {
            currentFilter = category;

            filterBtns.forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-category') === category);
            });

            if (updateUrl) {
                const newUrl = new URL(window.location);
                if (category === 'all') {
                    newUrl.searchParams.delete('category');
                } else {
                    newUrl.searchParams.set('category', category);
                }
                window.history.pushState({}, '', newUrl);
            }

            // Dispatch for 3D
            window.dispatchEvent(new CustomEvent('category-changed', { detail: { category } }));
            runFilter();
        }

        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => setCategory(btn.getAttribute('data-category'), true));
        });

        // Search
        function debounce(func, wait) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        const handleSearch = debounce((e) => {
            currentQuery = e.target.value.trim().toLowerCase().normalize('NFC');
            searchClear.style.display = currentQuery ? 'block' : 'none';
            runFilter();
        }, 200);

        searchInput.addEventListener('input', handleSearch);

        searchClear.addEventListener('click', () => {
            searchInput.value = '';
            currentQuery = '';
            searchClear.style.display = 'none';
            runFilter();
        });

        // URL Init - Support both category and tag parameters
        const urlParams = new URLSearchParams(window.location.search);
        const initialCategory = urlParams.get('category');
        const initialTag = urlParams.get('tag');

        if (initialCategory && document.querySelector(`.filter-btn[data-category="${initialCategory}"]`)) {
            setCategory(initialCategory, false);
        }

        // Handle tag filter from URL
        if (initialTag) {
            currentTag = initialTag;
            // Show tag indicator
            const tagIndicator = document.createElement('div');
            tagIndicator.className = 'tag-filter-indicator';
            tagIndicator.innerHTML = `<span>Tag: #${decodeURIComponent(initialTag)}</span><button id="clear-tag">√ó</button>`;
            tagIndicator.style.cssText = 'display:flex;align-items:center;gap:8px;background:rgba(71,85,105,0.8);color:#e2e8f0;padding:8px 16px;border-radius:8px;margin:0 auto 16px;width:fit-content;';
            document.querySelector('.page-header').appendChild(tagIndicator);

            document.getElementById('clear-tag').addEventListener('click', () => {
                currentTag = '';
                tagIndicator.remove();
                const newUrl = new URL(window.location);
                newUrl.searchParams.delete('tag');
                window.history.pushState({}, '', newUrl);
                runFilter();
            });

            runFilter();
        }
    });
</script>
{{ end }}