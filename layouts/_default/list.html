{{ define "main" }}
<!-- 3D Background Container (Preserved) -->
<div id="three-canvas-container"></div>

<!-- Inline CSS for 3D Container (Preserved for now, but background colors managed via Tailwind classes ideally later) -->
<style>
    #three-canvas-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        z-index: -1;
        /* Fallback for JS loading */
        background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
    }

    body.dark #three-canvas-container {
        background: radial-gradient(circle at 50% 50%, #232526 0%, #0f0c29 100%);
    }
</style>

<!-- Three.js Logic (Preserved exactly as is to ensure 3D still works) -->
<script type="module">
    import * as THREE from 'https://cdn.skypack.dev/three@0.132.2';
    // ... (Minimizing script duplication for this file view, but in reality we keep the original script block)
    // For this rewrite, I will assume the script is included via valid partial or just kept in the final file.
    // I will include the full script in the actual file write to avoid breaking functionality.

    // --- Zombie Killer ---
    if (window.posts3DReqId) {
        cancelAnimationFrame(window.posts3DReqId);
    }
    if (window.posts3DCleanup) {
        window.posts3DCleanup();
    }

    const container = document.getElementById('three-canvas-container');

    if (container) {
        // Scene
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 500);
        camera.position.set(0, 0, 70);

        // Renderer - Performance Optimized
        const renderer = new THREE.WebGLRenderer({
            alpha: true,
            antialias: false,  // Disable for performance
            powerPreference: "high-performance"
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5)); // Lower DPR limit
        container.appendChild(renderer.domElement);

        // Cinematic/Romance Lighting & Atmosphere
        scene.add(new THREE.AmbientLight(0xffffff, 0.6)); // Soft general light
        const mainLight = new THREE.DirectionalLight(0xffd1b3, 1.5); // Warm sunset key light
        mainLight.position.set(20, 20, 50);
        scene.add(mainLight);

        // Soft Fog for Depth (Cinematic Feel)
        scene.fog = new THREE.FogExp2(0x111116, 0.008);

        // Planet Group
        const group = new THREE.Group();
        scene.add(group);
        const planets = {};

        // Cinematic Materials
        const matteGold = new THREE.MeshStandardMaterial({
            color: 0xffac41, roughness: 0.7, metalness: 0.1, emissive: 0x553311, emissiveIntensity: 0.2
        });
        const matteBlue = new THREE.MeshStandardMaterial({
            color: 0x3e5eb3, roughness: 0.8, metalness: 0.0, emissive: 0x112244, emissiveIntensity: 0.3
        });
        const matteSilver = new THREE.MeshStandardMaterial({
            color: 0xcbd5e1, roughness: 0.5, metalness: 0.3
        });
        const softPearl = new THREE.MeshStandardMaterial({
            color: 0xfff1f2, roughness: 0.9, emissive: 0x332222, emissiveIntensity: 0.1
        });

        // Initial Positions
        const religionPlanet = new THREE.Mesh(new THREE.IcosahedronGeometry(7, 0), matteGold);
        group.add(religionPlanet);
        planets['religion'] = { mesh: religionPlanet, camPos: { x: 40, y: 15, z: -10 } };

        const philoPlanet = new THREE.Mesh(new THREE.OctahedronGeometry(6, 0), matteBlue);
        group.add(philoPlanet);
        planets['philosophy'] = { mesh: philoPlanet, camPos: { x: -40, y: 10, z: -15 } };

        const engPlanet = new THREE.Mesh(new THREE.IcosahedronGeometry(8, 0), matteSilver);
        group.add(engPlanet);
        planets['engineering'] = { mesh: engPlanet, camPos: { x: -45, y: -5, z: -20 } };

        const writePlanet = new THREE.Mesh(new THREE.SphereGeometry(5, 32, 32), softPearl);
        group.add(writePlanet);
        planets['writing'] = { mesh: writePlanet, camPos: { x: 45, y: -5, z: -10 } };

        function updatePlanetLayout() {
            const isMobile = window.innerWidth < 768;
            if (isMobile) {
                // Mobile: Small decorative planets at screen corners
                // Much smaller so they fit, positioned as corner accents
                Object.values(planets).forEach(p => p.mesh.scale.set(0.35, 0.35, 0.35));

                // Spread out to corners, closer to camera (Z=35-45)
                planets['religion'].mesh.position.set(25, 30, 35);      // Top Right
                planets['philosophy'].mesh.position.set(-25, 25, 40);   // Top Left
                planets['engineering'].mesh.position.set(-22, -20, 38); // Bottom Left
                planets['writing'].mesh.position.set(22, -25, 42);      // Bottom Right
            } else {
                Object.values(planets).forEach(p => p.mesh.scale.set(1, 1, 1));
                planets['religion'].mesh.position.set(60, 25, -40);
                planets['philosophy'].mesh.position.set(-60, 20, -40);
                planets['engineering'].mesh.position.set(-70, -5, -50);
                planets['writing'].mesh.position.set(70, -5, -30);
            }
        }
        updatePlanetLayout();

        const starGeo = new THREE.BufferGeometry();
        const starPos = new Float32Array(1500 * 3);
        for (let i = 0; i < 1500; i++) {
            starPos[i * 3] = (Math.random() - 0.5) * 400;
            starPos[i * 3 + 1] = (Math.random() - 0.5) * 400;
            starPos[i * 3 + 2] = (Math.random() - 0.5) * 200 - 80;
        }
        starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
        const starMat = new THREE.PointsMaterial({ size: 0.4, color: 0xffffff, transparent: true, opacity: 0.8 });
        const stars = new THREE.Points(starGeo, starMat);
        scene.add(stars);

        function updateStarColor() {
            const isDark = document.body.classList.contains('dark');
            if (isDark) {
                stars.material.color.setHex(0xffffff);
                stars.material.opacity = 0.6;
            } else {
                stars.material.color.setHex(0x445566);
                stars.material.opacity = 0.5;
            }
        }
        updateStarColor();
        const observer = new MutationObserver(updateStarColor);
        observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });

        let targetCameraPos = new THREE.Vector3(0, 0, 70);
        let targetLookAt = new THREE.Vector3(0, 0, 0);

        if (window.postsNavListener) {
            window.removeEventListener('category-changed', window.postsNavListener);
        }
        window.postsNavListener = (e) => {
            const cat = e.detail.category;
            if (cat === 'all' || !planets[cat]) {
                targetCameraPos.set(0, 0, 70);
                targetLookAt.set(0, 0, 0);
            } else {
                const p = planets[cat];
                targetCameraPos.set(p.camPos.x, p.camPos.y, p.camPos.z);
                targetLookAt.copy(p.mesh.position);
            }
        };
        window.addEventListener('category-changed', window.postsNavListener);

        function animate() {
            religionPlanet.rotation.y += 0.005;
            philoPlanet.rotation.y -= 0.004;
            engPlanet.rotation.x += 0.003;
            writePlanet.rotation.y += 0.004;
            camera.position.lerp(targetCameraPos, 0.05);
            camera.lookAt(targetLookAt);
            stars.rotation.z += 0.0002;
            renderer.render(scene, camera);
            window.posts3DReqId = requestAnimationFrame(animate);
        }
        animate();

        let resizeTimer;
        const onResize = () => {
            clearTimeout(resizeTimer);
            updatePlanetLayout();
            resizeTimer = setTimeout(() => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }, 100);
        };
        window.addEventListener('resize', onResize);

        window.posts3DCleanup = () => {
            window.removeEventListener('resize', onResize);
            if (window.postsNavListener) {
                window.removeEventListener('category-changed', window.postsNavListener);
            }
            renderer.dispose();
            renderer.forceContextLoss();
        };
    }
</script>

<section class="relative z-10 min-h-screen py-10 px-4">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-12">
            <h1
                class="text-4xl md:text-5xl font-bold text-slate-800 dark:text-slate-100 mb-4 tracking-tight drop-shadow-sm">
                Posts
            </h1>
            <p class="text-lg text-slate-500 dark:text-slate-400 mb-8">
                종교, 철학, 공학, 글쓰기에 대한 생각과 통찰을 나눕니다
            </p>

            <!-- Search Box -->
            <div class="relative max-w-xl mx-auto mb-8 group">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-slate-400 dark:text-slate-300 group-focus-within:text-indigo-500 transition-colors"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </div>
                <!-- INCREASED CONTRAST: dark:bg-slate-800 -> dark:bg-slate-900/80, dark:placeholder-slate-400 -> dark:placeholder-slate-300 -->
                <input type="text" id="search-input"
                    class="block w-full pl-11 pr-10 py-3 bg-white/90 dark:bg-slate-900/80 backdrop-blur-md border border-slate-200 dark:border-slate-500 rounded-full text-slate-900 dark:text-white placeholder-slate-500 dark:placeholder-slate-300 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 transition-all shadow-lg hover:shadow-xl"
                    placeholder="검색어를 입력하세요..." autocomplete="off">
                <button id="search-clear"
                    class="absolute inset-y-0 right-0 pr-4 flex items-center text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 cursor-pointer hidden">
                    <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <!-- Filter Categories: Mobile-First Grid for guaranteed fit -->
            <div class="grid grid-cols-3 sm:grid-cols-5 gap-2 category-filters w-full max-w-lg mx-auto px-2">
                <!-- ALL BUTTON -->
                <button
                    class="filter-btn active group relative px-2 py-2 md:px-4 md:py-2.5 rounded-full bg-indigo-100 dark:bg-slate-700 border-2 border-indigo-500 shadow-sm transition-all duration-200"
                    data-category="all">
                    <span
                        class="flex items-center justify-center gap-1 text-xs md:text-sm font-bold text-indigo-700 dark:text-indigo-300 whitespace-nowrap">
                        <svg class="w-3 h-3 md:w-4 md:h-4 hidden sm:block" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                        </svg>
                        전체
                    </span>
                </button>

                {{ range $catName, $catData := .Site.Data.categories }}
                <!-- CATEGORY BUTTON -->
                <button
                    class="filter-btn group relative px-2 py-2 md:px-4 md:py-2.5 rounded-full bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 shadow-sm hover:shadow-md transition-all duration-200"
                    data-category="{{ $catName }}">
                    <span
                        class="flex items-center justify-center gap-1 text-xs md:text-sm font-bold text-slate-600 dark:text-slate-200 truncate"
                        style="--hover-color: {{ $catData.color | default " #6366f1" }}">
                        <span
                            class="text-slate-500 dark:text-slate-400 group-hover:text-[var(--hover-color)] transition-colors">{{
                            $catData.icon | safeHTML }}</span>
                        <span class="group-hover:text-[var(--hover-color)] transition-colors truncate">{{ $catData.name
                            }}</span>
                    </span>
                    <div class="absolute inset-0 rounded-full ring-2 opacity-0 group-[.active]:opacity-100 transition-opacity"
                        style="--ring-color: {{ $catData.color | default " #6366f1" }}; box-shadow: 0 0 0 2px
                        var(--ring-color);"></div>
                </button>
                {{ end }}
            </div>
        </header>

        <!-- Premium Grid Layout -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 timeline-items">
            {{ $posts := where .Site.RegularPages "Section" "posts" }}
            {{ $posts = $posts.ByDate.Reverse }}

            {{ range $posts }}
            {{ $category := "uncategorized" }}
            {{ if .Params.categories }}
            {{ $category = index .Params.categories 0 | lower }}
            {{ end }}

            {{ $catData := index $.Site.Data.categories $category }}
            {{ $catColor := "#64748b" }}
            {{ $catIcon := "" }}
            {{ $catName := $category }}
            {{ if $catData }}
            {{ $catColor = $catData.color }}
            {{ $catIcon = $catData.icon }}
            {{ $catName = $catData.name }}
            {{ end }}

            <article
                class="timeline-item group relative flex flex-col h-full bg-white/60 dark:bg-slate-900/40 backdrop-blur-md rounded-2xl border border-white/40 dark:border-slate-700 shadow-lg hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 overflow-hidden"
                data-category="{{ $category }}">
                <!-- Top Accent Line -->
                <div class="h-1.5 w-full" style="background-color: {{ $catColor }}"></div>

                <div class="p-6 flex flex-col flex-grow">
                    <!-- Meta -->
                    <div class="flex items-center justify-between mb-4 text-xs font-bold tracking-wider uppercase">
                        <span class="flex items-center gap-1.5" style="color: {{ $catColor }}">
                            {{ $catIcon | safeHTML }} {{ $catName }}
                        </span>
                        <span class="text-slate-500 dark:text-slate-400 font-mono">{{ .Date.Format "2006.01.02"
                            }}</span>
                    </div>

                    <!-- Title -->
                    <h2
                        class="text-xl font-bold text-slate-900 dark:text-white mb-3 leading-snug group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">
                        <a href="{{ .RelPermalink }}" class="block focus:outline-none">
                            <span class="absolute inset-0"></span>
                            {{ .Title }}
                        </a>
                    </h2>

                    <!-- Excerpt -->
                    <p class="text-slate-700 dark:text-slate-300 text-sm leading-relaxed line-clamp-3 mb-5 flex-grow">
                        {{ .Summary | plainify | htmlUnescape }}
                    </p>

                    <!-- Footer / Read More -->
                    <div
                        class="flex items-center text-indigo-600 dark:text-indigo-400 text-sm font-bold mt-auto group-hover:translate-x-1 transition-transform">
                        Read Article
                        <svg class="w-4 h-4 ml-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                            <polyline points="12 5 19 12 12 19"></polyline>
                        </svg>
                    </div>
                </div>
            </article>
            {{ end }}
        </div>

        {{ if not $posts }}
        <div class="text-center py-20">
            <p class="text-slate-500 dark:text-slate-400 text-lg">아직 작성된 글이 없습니다.</p>
        </div>
        {{ end }}
    </div>
</section>

<!-- Filter & Search Script (Updated for new DOM structure) -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const filterBtns = document.querySelectorAll('.filter-btn');
        const searchInput = document.getElementById('search-input');
        const searchClear = document.getElementById('search-clear');
        const items = Array.from(document.querySelectorAll('.timeline-item'));

        // Cache data for performance
        const itemsData = items.map(item => {
            const titleEl = item.querySelector('h2');
            const excerptEl = item.querySelector('p');
            return {
                element: item,
                category: item.getAttribute('data-category'),
                text: (
                    (titleEl?.textContent || '') + ' ' +
                    (excerptEl?.textContent || '')
                ).toLowerCase().normalize('NFC')
            };
        });

        let currentFilter = 'all';
        let currentQuery = '';

        function runFilter() {
            itemsData.forEach(data => {
                const matchesCategory = currentFilter === 'all' || data.category === currentFilter;
                const matchesSearch = !currentQuery || data.text.includes(currentQuery);
                const shouldShow = matchesCategory && matchesSearch;

                if (shouldShow) {
                    data.element.classList.remove('hidden');
                    // Add fade-in animation class if needed, or just standard display
                } else {
                    data.element.classList.add('hidden');
                }
            });
        }

        function setCategory(category, updateUrl = false) {
            currentFilter = category;

            // Visual Active State (Tailwind classes)
            filterBtns.forEach(btn => {
                const isActive = btn.getAttribute('data-category') === category;
                if (isActive) {
                    btn.classList.add('active', 'ring-2', 'ring-indigo-500', 'border-transparent');
                    btn.classList.remove('border-slate-200', 'dark:border-slate-700');
                } else {
                    btn.classList.remove('active', 'ring-2', 'ring-indigo-500', 'border-transparent');
                    btn.classList.add('border-slate-200', 'dark:border-slate-700');
                }
            });

            if (updateUrl) {
                const newUrl = new URL(window.location);
                if (category === 'all') {
                    newUrl.searchParams.delete('category');
                } else {
                    newUrl.searchParams.set('category', category);
                }
                window.history.pushState({}, '', newUrl);
            }

            // Dispatch for 3D
            window.dispatchEvent(new CustomEvent('category-changed', { detail: { category } }));
            runFilter();
        }

        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => setCategory(btn.getAttribute('data-category'), true));
        });

        // Search Debounce
        function debounce(func, wait) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        const handleSearch = debounce((e) => {
            currentQuery = e.target.value.trim().toLowerCase().normalize('NFC');
            if (currentQuery) {
                searchClear.classList.remove('hidden');
            } else {
                searchClear.classList.add('hidden');
            }
            runFilter();
        }, 200);

        searchInput.addEventListener('input', handleSearch);

        searchClear.addEventListener('click', () => {
            searchInput.value = '';
            currentQuery = '';
            searchClear.classList.add('hidden');
            runFilter();
        });

        // URL Init
        const urlParams = new URLSearchParams(window.location.search);
        const initialCategory = urlParams.get('category');
        if (initialCategory && document.querySelector(`.filter-btn[data-category="${initialCategory}"]`)) {
            setCategory(initialCategory, false);
        }
    });
</script>
{{ end }}